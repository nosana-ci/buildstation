nosana:
  description: Solana hello world

global:
  image: nosana/solana:v1.0.3

  trigger:
    branch:
      - master

jobs:
  - name: build
    commands:
      - npm run build:program-rust
    artifacts:
      - name: program
        path: dist/program/helloworld.so

  - name: deliver
    environment:
      SOLANA_WALLET:
        type: nosana/secret
        endpoint: https://secrets.k8s.dev.nos.ci/
        value: SOLANA_WALLET
    commands:
      - echo $SOLANA_WALLET > key.json
      - solana config set --url devnet --keypair $(pwd)/key.json
      - solana program write-buffer /dist/helloworld.so | tee buffer.txt
    resources:
      - name: program
        path: /dist
    artifacts:
      - name: buffer
        path: buffer.txt

  - name: deploy
    commands:
      - BUFFER=$(< /buffer.txt)
      - |
        echo Deploying buffer ${BUFFER#*: }
    resources:
      - name: buffer
        path: /buffer.txt
